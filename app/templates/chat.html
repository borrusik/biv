<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–ß–∞—Ç –¥–ª—è –¥–≤–æ–∏—Ö</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="container py-4">
    <h3 class="mb-3">–ü—Ä–∏–≤–µ—Ç, {{ username }}!</h3>

    <div
      class="border rounded p-3 mb-3"
      style="height: 300px; overflow-y: auto"
    >
      {% for name, content, kind in messages %}
      <div>
        <b>{{ name }}:</b>
        {% if kind == 'text' %} {{ content }} {% elif kind == 'voice' %}
        <audio
          controls
          src="{{ url_for('voice_file', filename=content) }}"
        ></audio>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <form method="post" action="/send" class="d-flex mb-3">
      <input
        name="message"
        class="form-control me-2"
        placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."
        required
      />
      <button class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>

    <button id="recordBtn" class="btn btn-secondary">üéô –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å</button>

    <script>
      const recordBtn = document.getElementById("recordBtn");
      let mediaRecorder,
        chunks = [];
      const chatBox = document.querySelector(".border");

      recordBtn.onclick = async () => {
        console.log("[DEBUG] –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞, –∑–∞–ø—É—Å–∫–∞–µ–º getUserMedia");
        try {
          if (!mediaRecorder || mediaRecorder.state === "inactive") {
            console.log("[üéô] –ù–∞—á–∏–Ω–∞—é –∑–∞–ø–∏—Å—å...");
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            console.log("[DEBUG] –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω");

            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (e) => {
              chunks.push(e.data);
              console.log("[üéô] –ü–æ–ª—É—á–µ–Ω –∫—É—Å–æ–∫ –∞—É–¥–∏–æ.");
            };

            mediaRecorder.onstop = async () => {
              console.log("[üéô] –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å.");
              const blob = new Blob(chunks, { type: "audio/webm" });
              chunks = [];
              const formData = new FormData();
              formData.append("voice", blob, "voice.webm");

              console.log("[‚¨ÜÔ∏è] –û—Ç–ø—Ä–∞–≤–ª—è—é –≥–æ–ª–æ—Å–æ–≤–æ–µ...");
              const resp = await fetch("/send_voice", {
                method: "POST",
                body: formData,
              });

              console.log("[‚úÖ] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", resp.status);
            };

            mediaRecorder.start();
            recordBtn.textContent = "‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
          } else {
            mediaRecorder.stop();
            recordBtn.textContent = "üéô –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å";
          }
        } catch (err) {
          console.error("[‚ùå] –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:", err);
          alert(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ."
          );
        }
      };

      // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
      let lastLength = 0;

      async function loadMessages() {
        const res = await fetch("/messages");
        const data = await res.json();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ
        if (data.length !== lastLength) {
          lastLength = data.length;
          chatBox.innerHTML = "";
          data.forEach((msg) => {
            const div = document.createElement("div");
            div.innerHTML = `<b>${msg.name}:</b> ${
              msg.type === "text"
                ? msg.content
                : `<audio controls src="/static/voices/${msg.content}"></audio>`
            }`;
            chatBox.appendChild(div);
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫
      setInterval(loadMessages, 2000);
      loadMessages();
    </script>
  </body>
</html>
